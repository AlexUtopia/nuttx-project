diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/teensy/nsh/defconfig src/nuttx/configs/teensy/nsh/defconfig
--- tmp/nuttx/configs/teensy/nsh/defconfig	2015-05-25 19:55:23.126821951 +0300
+++ src/nuttx/configs/teensy/nsh/defconfig	2015-05-31 20:27:25.631100442 +0300
@@ -20,7 +20,8 @@ CONFIG_WINDOWS_CYGWIN=y
 #
 # Build Configuration
 #
-# CONFIG_APPS_DIR="../apps"
+CONFIG_APPS_DIR="../apps"
+CONFIG_BUILD_FLAT=y
 # CONFIG_BUILD_2PASS is not set
 
 #
@@ -30,10 +31,12 @@ CONFIG_WINDOWS_CYGWIN=y
 CONFIG_INTELHEX_BINARY=y
 # CONFIG_MOTOROLA_SREC is not set
 # CONFIG_RAW_BINARY is not set
+# CONFIG_UBOOT_UIMAGE is not set
 
 #
 # Customize Header Files
 #
+# CONFIG_ARCH_STDINT_H is not set
 # CONFIG_ARCH_STDBOOL_H is not set
 # CONFIG_ARCH_MATH_H is not set
 # CONFIG_ARCH_FLOAT_H is not set
@@ -43,13 +46,15 @@ CONFIG_INTELHEX_BINARY=y
 # Debug Options
 #
 # CONFIG_DEBUG is not set
-CONFIG_ARCH_HAVE_STACKCHECK=y
 # CONFIG_ARCH_HAVE_HEAPCHECK is not set
-# CONFIG_DEBUG_SYMBOLS is not set
+CONFIG_ARCH_HAVE_STACKCHECK=y
+# CONFIG_STACK_COLORATION is not set
+CONFIG_DEBUG_SYMBOLS=y
 CONFIG_ARCH_HAVE_CUSTOMOPT=y
 # CONFIG_DEBUG_NOOPT is not set
-# CONFIG_DEBUG_CUSTOMOPT is not set
-CONFIG_DEBUG_FULLOPT=y
+CONFIG_DEBUG_CUSTOMOPT=y
+# CONFIG_DEBUG_FULLOPT is not set
+CONFIG_DEBUG_OPTLEVEL="-O0"
 
 #
 # System Type
@@ -67,14 +72,11 @@ CONFIG_ARCH_AVR=y
 CONFIG_ARCH="avr"
 CONFIG_ARCH_FAMILY="avr"
 CONFIG_ARCH_CHIP="at90usb"
-# CONFIG_ARCH_CHIP_ATMEGA128 is not set
-# CONFIG_ARCH_CHIP_AT90USB646 is not set
-# CONFIG_ARCH_CHIP_AT90USB647 is not set
-CONFIG_ARCH_CHIP_AT90USB1286=y
-# CONFIG_ARCH_CHIP_AT90USB1287 is not set
-# CONFIG_ARCH_CHIP_AT32UC3B0256 is not set
-CONFIG_ARCH_FAMILY_AVR=y
+# CONFIG_ARCH_CHIP_ATMEGA is not set
 CONFIG_ARCH_CHIP_AT90USB=y
+# CONFIG_ARCH_CHIP_AT32UC3 is not set
+CONFIG_ARCH_FAMILY_AVR=y
+# CONFIG_ARCH_FAMILY_AVR32 is not set
 
 #
 # AVR Configuration Options
@@ -85,16 +87,19 @@ CONFIG_AVR_BUILDROOT=y
 #
 # AT90USB Configuration Options
 #
+# CONFIG_ARCH_CHIP_AT90USB646 is not set
+# CONFIG_ARCH_CHIP_AT90USB647 is not set
+CONFIG_ARCH_CHIP_AT90USB1286=y
+# CONFIG_ARCH_CHIP_AT90USB1287 is not set
 
 #
 # AT90USB Peripheral Selections
 #
-# CONFIG_AVR_SPI is not set
+CONFIG_AVR_SPI=y
 CONFIG_AVR_USART1=y
-# CONFIG_AVR_USBDEV is not set
+CONFIG_AVR_USBDEV=y
 # CONFIG_AVR_WDT is not set
 # CONFIG_AVR_GPIOIRQ is not set
-# CONFIG_AVR_USART0 is not set
 
 #
 # Architecture Options
@@ -103,10 +108,15 @@ CONFIG_ARCH_NOINTC=y
 # CONFIG_ARCH_VECNOTIRQ is not set
 # CONFIG_ARCH_DMA is not set
 # CONFIG_ARCH_HAVE_IRQPRIO is not set
-# CONFIG_ARCH_ADDRENV is not set
+# CONFIG_ARCH_L2CACHE is not set
+# CONFIG_ARCH_HAVE_COHERENT_DCACHE is not set
+# CONFIG_ARCH_HAVE_ADDRENV is not set
+# CONFIG_ARCH_NEED_ADDRENV_MAPPING is not set
 # CONFIG_ARCH_HAVE_VFORK is not set
 # CONFIG_ARCH_HAVE_MMU is not set
+# CONFIG_ARCH_HAVE_MPU is not set
 # CONFIG_ARCH_NAND_HWECC is not set
+# CONFIG_ARCH_HAVE_EXTCLK is not set
 CONFIG_ARCH_STACKDUMP=y
 # CONFIG_ENDIAN_BIG is not set
 # CONFIG_ARCH_IDLE_CUSTOM is not set
@@ -155,44 +165,79 @@ CONFIG_ARCH_BOARD="teensy"
 #
 CONFIG_ARCH_HAVE_LEDS=y
 CONFIG_ARCH_LEDS=y
-CONFIG_NSH_MMCSDMINOR=0
 
 #
 # Board-Specific Options
 #
+CONFIG_LIB_BOARDCTL=y
+# CONFIG_BOARDCTL_TSCTEST is not set
+# CONFIG_BOARDCTL_ADCTEST is not set
+# CONFIG_BOARDCTL_GRAPHICS is not set
+# CONFIG_BOARDCTL_IOCTL is not set
 
 #
 # RTOS Features
 #
-# CONFIG_BOARD_INITIALIZE is not set
+CONFIG_DISABLE_OS_API=y
+CONFIG_DISABLE_POSIX_TIMERS=y
+CONFIG_DISABLE_PTHREAD=y
+# CONFIG_DISABLE_SIGNALS is not set
+CONFIG_DISABLE_MQUEUE=y
+CONFIG_DISABLE_ENVIRON=y
+
+#
+# Clocks and Timers
+#
 CONFIG_USEC_PER_TICK=10000
 # CONFIG_SYSTEM_TIME64 is not set
-CONFIG_RR_INTERVAL=200
-# CONFIG_SCHED_CPULOAD is not set
-# CONFIG_SCHED_INSTRUMENTATION is not set
-CONFIG_TASK_NAME_SIZE=0
-# CONFIG_SCHED_HAVE_PARENT is not set
+# CONFIG_CLOCK_MONOTONIC is not set
 # CONFIG_JULIAN_TIME is not set
 CONFIG_START_YEAR=2010
 CONFIG_START_MONTH=6
 CONFIG_START_DAY=17
+CONFIG_MAX_WDOGPARMS=1
+CONFIG_PREALLOC_WDOGS=1
+CONFIG_WDOG_INTRESERVE=0
+CONFIG_PREALLOC_TIMERS=0
+
+#
+# Tasks and Scheduling
+#
+# CONFIG_INIT_NONE is not set
+CONFIG_INIT_ENTRYPOINT=y
+# CONFIG_INIT_FILEPATH is not set
+CONFIG_USER_ENTRYPOINT="msconn_main"
+CONFIG_RR_INTERVAL=200
+CONFIG_TASK_NAME_SIZE=0
+CONFIG_MAX_TASKS=4
+# CONFIG_SCHED_HAVE_PARENT is not set
+# CONFIG_SCHED_WAITPID is not set
+
+#
+# Performance Monitoring
+#
+# CONFIG_SCHED_CPULOAD is not set
+# CONFIG_SCHED_INSTRUMENTATION is not set
+
+#
+# Files and I/O
+#
 CONFIG_DEV_CONSOLE=y
-# CONFIG_MUTEX_TYPES is not set
-# CONFIG_PRIORITY_INHERITANCE is not set
 # CONFIG_FDCLONE_DISABLE is not set
-# CONFIG_FDCLONE_STDIO is not set
+CONFIG_FDCLONE_STDIO=y
 CONFIG_SDCLONE_DISABLE=y
-# CONFIG_SCHED_WAITPID is not set
+CONFIG_NFILE_DESCRIPTORS=4
+CONFIG_NFILE_STREAMS=4
+CONFIG_NAME_MAX=32
+# CONFIG_PRIORITY_INHERITANCE is not set
+
+#
+# RTOS hooks
+#
+# CONFIG_BOARD_INITIALIZE is not set
 # CONFIG_SCHED_STARTHOOK is not set
 # CONFIG_SCHED_ATEXIT is not set
 # CONFIG_SCHED_ONEXIT is not set
-CONFIG_USER_ENTRYPOINT="nsh_main"
-CONFIG_DISABLE_OS_API=y
-CONFIG_DISABLE_POSIX_TIMERS=y
-CONFIG_DISABLE_PTHREAD=y
-# CONFIG_DISABLE_SIGNALS is not set
-CONFIG_DISABLE_MQUEUE=y
-# CONFIG_DISABLE_ENVIRON is not set
 
 #
 # Signal Numbers
@@ -202,43 +247,52 @@ CONFIG_SIG_SIGUSR2=2
 CONFIG_SIG_SIGALARM=3
 
 #
-# Sizes of configurable things (0 disables)
+# Work Queue Support
 #
-CONFIG_MAX_TASKS=8
-CONFIG_NPTHREAD_KEYS=0
-CONFIG_NFILE_DESCRIPTORS=6
-CONFIG_NFILE_STREAMS=6
-CONFIG_NAME_MAX=32
-CONFIG_PREALLOC_MQ_MSGS=0
-CONFIG_MQ_MAXMSGSIZE=0
-CONFIG_MAX_WDOGPARMS=2
-CONFIG_PREALLOC_WDOGS=4
-CONFIG_WDOG_INTRESERVE=0
-CONFIG_PREALLOC_TIMERS=0
+# CONFIG_SCHED_WORKQUEUE is not set
+# CONFIG_SCHED_HPWORK is not set
+# CONFIG_SCHED_LPWORK is not set
 
 #
 # Stack and heap information
 #
-CONFIG_IDLETHREAD_STACKSIZE=512
-CONFIG_USERMAIN_STACKSIZE=512
+CONFIG_IDLETHREAD_STACKSIZE=256
+CONFIG_USERMAIN_STACKSIZE=768
 CONFIG_PTHREAD_STACK_MIN=256
-CONFIG_PTHREAD_STACK_DEFAULT=512
+CONFIG_PTHREAD_STACK_DEFAULT=768
+# CONFIG_LIB_SYSCALL is not set
 
 #
 # Device Drivers
 #
 CONFIG_DISABLE_POLL=y
-CONFIG_DEV_NULL=y
+# CONFIG_DEV_NULL is not set
 # CONFIG_DEV_ZERO is not set
 # CONFIG_LOOP is not set
+
+#
+# Buffering
+#
+# CONFIG_DRVR_WRITEBUFFER is not set
+# CONFIG_DRVR_READAHEAD is not set
 # CONFIG_RAMDISK is not set
 # CONFIG_CAN is not set
 # CONFIG_ARCH_HAVE_PWM_PULSECOUNT is not set
 # CONFIG_PWM is not set
 # CONFIG_ARCH_HAVE_I2CRESET is not set
 # CONFIG_I2C is not set
-# CONFIG_SPI is not set
+CONFIG_SPI=y
+CONFIG_SPI_OWNBUS=y
+# CONFIG_SPI_EXCHANGE is not set
+# CONFIG_SPI_CMDDATA is not set
+# CONFIG_SPI_CALLBACK is not set
+# CONFIG_SPI_BITBANG is not set
 # CONFIG_I2S is not set
+
+#
+# Timer Driver Support
+#
+# CONFIG_TIMER is not set
 # CONFIG_RTC is not set
 # CONFIG_WATCHDOG is not set
 # CONFIG_ANALOG is not set
@@ -248,7 +302,36 @@ CONFIG_DEV_NULL=y
 # CONFIG_INPUT is not set
 # CONFIG_LCD is not set
 # CONFIG_MMCSD is not set
-# CONFIG_MTD is not set
+CONFIG_MTD=y
+
+#
+# MTD Configuration
+#
+# CONFIG_MTD_PARTITION is not set
+# CONFIG_MTD_SECT512 is not set
+# CONFIG_MTD_BYTE_WRITE is not set
+# CONFIG_MTD_CONFIG is not set
+
+#
+# MTD Device Drivers
+#
+# CONFIG_MTD_NAND is not set
+# CONFIG_RAMMTD is not set
+# CONFIG_MTD_AT24XX is not set
+# CONFIG_MTD_AT25 is not set
+# CONFIG_MTD_AT45DB is not set
+CONFIG_MTD_M25P=y
+CONFIG_M25P_SPIMODE=0
+CONFIG_M25P_MANUFACTURER=0x20
+CONFIG_M25P_MEMORY_TYPE=0x80
+CONFIG_M25P_SUBSECTOR_ERASE=y
+# CONFIG_MTD_SMART is not set
+# CONFIG_MTD_RAMTRON is not set
+# CONFIG_MTD_SST25 is not set
+# CONFIG_MTD_SST25XX is not set
+# CONFIG_MTD_SST39FV is not set
+# CONFIG_MTD_W25 is not set
+# CONFIG_EEPROM is not set
 # CONFIG_PIPES is not set
 # CONFIG_PM is not set
 # CONFIG_POWER is not set
@@ -257,7 +340,28 @@ CONFIG_DEV_NULL=y
 CONFIG_SERIAL=y
 # CONFIG_DEV_LOWCONSOLE is not set
 # CONFIG_16550_UART is not set
+# CONFIG_ARCH_HAVE_UART is not set
+# CONFIG_ARCH_HAVE_UART0 is not set
+# CONFIG_ARCH_HAVE_UART1 is not set
+# CONFIG_ARCH_HAVE_UART2 is not set
+# CONFIG_ARCH_HAVE_UART3 is not set
+# CONFIG_ARCH_HAVE_UART4 is not set
+# CONFIG_ARCH_HAVE_UART5 is not set
+# CONFIG_ARCH_HAVE_UART6 is not set
+# CONFIG_ARCH_HAVE_UART7 is not set
+# CONFIG_ARCH_HAVE_UART8 is not set
+# CONFIG_ARCH_HAVE_SCI0 is not set
+# CONFIG_ARCH_HAVE_SCI1 is not set
+# CONFIG_ARCH_HAVE_USART0 is not set
 CONFIG_ARCH_HAVE_USART1=y
+# CONFIG_ARCH_HAVE_USART2 is not set
+# CONFIG_ARCH_HAVE_USART3 is not set
+# CONFIG_ARCH_HAVE_USART4 is not set
+# CONFIG_ARCH_HAVE_USART5 is not set
+# CONFIG_ARCH_HAVE_USART6 is not set
+# CONFIG_ARCH_HAVE_USART7 is not set
+# CONFIG_ARCH_HAVE_USART8 is not set
+# CONFIG_ARCH_HAVE_OTHER_UART is not set
 
 #
 # USART Configuration
@@ -265,23 +369,60 @@ CONFIG_ARCH_HAVE_USART1=y
 CONFIG_USART1_ISUART=y
 CONFIG_MCU_SERIAL=y
 CONFIG_STANDARD_SERIAL=y
+# CONFIG_SERIAL_IFLOWCONTROL is not set
+# CONFIG_SERIAL_OFLOWCONTROL is not set
+# CONFIG_ARCH_HAVE_SERIAL_TERMIOS is not set
 CONFIG_USART1_SERIAL_CONSOLE=y
+# CONFIG_OTHER_SERIAL_CONSOLE is not set
 # CONFIG_NO_SERIAL_CONSOLE is not set
 
 #
 # USART1 Configuration
 #
-CONFIG_USART1_RXBUFSIZE=256
-CONFIG_USART1_TXBUFSIZE=256
+CONFIG_USART1_RXBUFSIZE=16
+CONFIG_USART1_TXBUFSIZE=8
 CONFIG_USART1_BAUD=38400
 CONFIG_USART1_BITS=8
 CONFIG_USART1_PARITY=0
 CONFIG_USART1_2STOP=0
 # CONFIG_USART1_IFLOWCONTROL is not set
 # CONFIG_USART1_OFLOWCONTROL is not set
-# CONFIG_SERIAL_IFLOWCONTROL is not set
-# CONFIG_SERIAL_OFLOWCONTROL is not set
-# CONFIG_USBDEV is not set
+CONFIG_USBDEV=y
+
+#
+# USB Device Controller Driver Options
+#
+# CONFIG_USBDEV_ISOCHRONOUS is not set
+# CONFIG_USBDEV_DUALSPEED is not set
+CONFIG_USBDEV_SELFPOWERED=y
+# CONFIG_USBDEV_BUSPOWERED is not set
+CONFIG_USBDEV_MAXPOWER=100
+# CONFIG_USBDEV_DMA is not set
+# CONFIG_ARCH_USBDEV_STALLQUEUE is not set
+# CONFIG_USBDEV_TRACE is not set
+
+#
+# USB Device Class Driver Options
+#
+# CONFIG_USBDEV_COMPOSITE is not set
+# CONFIG_PL2303 is not set
+# CONFIG_CDCACM is not set
+CONFIG_USBMSC=y
+CONFIG_USBMSC_EP0MAXPACKET=64
+CONFIG_USBMSC_EPBULKOUT=2
+CONFIG_USBMSC_EPBULKIN=3
+CONFIG_USBMSC_NWRREQS=4
+CONFIG_USBMSC_NRDREQS=4
+CONFIG_USBMSC_BULKINREQLEN=64
+CONFIG_USBMSC_BULKOUTREQLEN=64
+CONFIG_USBMSC_VENDORID=0x584e
+CONFIG_USBMSC_VENDORSTR="NuttX"
+CONFIG_USBMSC_PRODUCTID=0x5342
+CONFIG_USBMSC_PRODUCTSTR="Mass Storage"
+CONFIG_USBMSC_VERSIONNO=0x399
+# CONFIG_USBMSC_REMOVABLE is not set
+CONFIG_USBMSC_SCSI_PRIO=128
+CONFIG_USBMSC_SCSI_STACKSIZE=2048
 # CONFIG_USBHOST is not set
 # CONFIG_WIRELESS is not set
 
@@ -293,6 +434,7 @@ CONFIG_USART1_2STOP=0
 # System Logging
 #
 # CONFIG_RAMLOG is not set
+# CONFIG_SYSLOG_CONSOLE is not set
 
 #
 # Networking Support
@@ -302,24 +444,39 @@ CONFIG_USART1_2STOP=0
 # CONFIG_NET is not set
 
 #
+# Crypto API
+#
+# CONFIG_CRYPTO is not set
+
+#
 # File Systems
 #
 
 #
 # File system configuration
 #
-CONFIG_DISABLE_MOUNTPOINT=y
+# CONFIG_DISABLE_MOUNTPOINT is not set
+# CONFIG_FS_AUTOMOUNTER is not set
 CONFIG_DISABLE_PSEUDOFS_OPERATIONS=y
-# CONFIG_FS_READABLE is not set
-# CONFIG_FS_WRITABLE is not set
+CONFIG_FS_READABLE=y
+CONFIG_FS_WRITABLE=y
+# CONFIG_FS_NAMED_SEMAPHORES is not set
 # CONFIG_FS_RAMMAP is not set
+CONFIG_FS_FAT=y
+# CONFIG_FAT_LCNAMES is not set
+# CONFIG_FAT_LFN is not set
+# CONFIG_FS_FATTIME is not set
+# CONFIG_FAT_DMAMEMORY is not set
+# CONFIG_FS_NXFFS is not set
+# CONFIG_FS_ROMFS is not set
+# CONFIG_FS_SMARTFS is not set
 # CONFIG_FS_PROCFS is not set
 
 #
 # System Logging
 #
-
 # CONFIG_SYSLOG is not set
+# CONFIG_SYSLOG_TIMESTAMP is not set
 
 #
 # Graphics Support
@@ -329,7 +486,7 @@ CONFIG_DISABLE_PSEUDOFS_OPERATIONS=y
 #
 # Memory Management
 #
-# CONFIG_MM_SMALL is not set
+CONFIG_MM_SMALL=y
 CONFIG_MM_REGIONS=1
 # CONFIG_ARCH_HAVE_HEAP2 is not set
 # CONFIG_GRAN is not set
@@ -340,10 +497,9 @@ CONFIG_MM_REGIONS=1
 # CONFIG_AUDIO is not set
 
 #
-# Binary Formats
+# Binary Loader
 #
 # CONFIG_BINFMT_DISABLE is not set
-# CONFIG_BINFMT_EXEPATH is not set
 # CONFIG_NXFLAT is not set
 # CONFIG_ELF is not set
 # CONFIG_BUILTIN is not set
@@ -360,10 +516,10 @@ CONFIG_MM_REGIONS=1
 CONFIG_STDIO_BUFFER_SIZE=0
 CONFIG_STDIO_LINEBUFFER=y
 CONFIG_NUNGET_CHARS=0
-CONFIG_LIB_HOMEDIR="/"
 # CONFIG_LIBM is not set
 CONFIG_NOPRINTF_FIELDWIDTH=y
 # CONFIG_LIBC_FLOATINGPOINT is not set
+# CONFIG_LIBC_IOCTL_VARIADIC is not set
 CONFIG_LIB_RAND_ORDER=1
 # CONFIG_EOL_IS_CR is not set
 # CONFIG_EOL_IS_LF is not set
@@ -374,7 +530,10 @@ CONFIG_POSIX_SPAWN_PROXY_STACKSIZE=1024
 CONFIG_TASK_SPAWN_DEFAULT_STACKSIZE=2048
 # CONFIG_LIBC_STRERROR is not set
 # CONFIG_LIBC_PERROR_STDOUT is not set
+CONFIG_LIBC_TMPDIR="/tmp"
+CONFIG_LIBC_MAX_TMPFILE=32
 CONFIG_ARCH_LOWPUTC=y
+# CONFIG_TIME_EXTENDED is not set
 CONFIG_LIB_SENDFILE_BUFSIZE=512
 # CONFIG_ARCH_ROMGETC is not set
 # CONFIG_ARCH_OPTIMIZED_FUNCTIONS is not set
@@ -382,7 +541,6 @@ CONFIG_LIB_SENDFILE_BUFSIZE=512
 #
 # Non-standard Library Support
 #
-# CONFIG_SCHED_WORKQUEUE is not set
 # CONFIG_LIB_KBDCODEC is not set
 # CONFIG_LIB_SLCDCODEC is not set
 
@@ -406,6 +564,7 @@ CONFIG_LIB_SENDFILE_BUFSIZE=512
 # CONFIG_EXAMPLES_BUTTONS is not set
 # CONFIG_EXAMPLES_CAN is not set
 # CONFIG_EXAMPLES_CONFIGDATA is not set
+# CONFIG_EXAMPLES_CPUHOG is not set
 # CONFIG_EXAMPLES_DHCPD is not set
 # CONFIG_EXAMPLES_ELF is not set
 # CONFIG_EXAMPLES_FTPC is not set
@@ -416,12 +575,11 @@ CONFIG_LIB_SENDFILE_BUFSIZE=512
 # CONFIG_EXAMPLES_HIDKBD is not set
 # CONFIG_EXAMPLES_KEYPADTEST is not set
 # CONFIG_EXAMPLES_IGMP is not set
-# CONFIG_EXAMPLES_LCDRW is not set
 # CONFIG_EXAMPLES_MM is not set
 # CONFIG_EXAMPLES_MODBUS is not set
 # CONFIG_EXAMPLES_MOUNT is not set
 # CONFIG_EXAMPLES_NRF24L01TERM is not set
-CONFIG_EXAMPLES_NSH=y
+# CONFIG_EXAMPLES_NSH is not set
 # CONFIG_EXAMPLES_NULL is not set
 # CONFIG_EXAMPLES_NX is not set
 # CONFIG_EXAMPLES_NXTERM is not set
@@ -432,14 +590,16 @@ CONFIG_EXAMPLES_NSH=y
 # CONFIG_EXAMPLES_NXLINES is not set
 # CONFIG_EXAMPLES_NXTEXT is not set
 # CONFIG_EXAMPLES_OSTEST is not set
-# CONFIG_EXAMPLES_PASHELLO is not set
 # CONFIG_EXAMPLES_PIPE is not set
 # CONFIG_EXAMPLES_POLL is not set
+# CONFIG_EXAMPLES_PPPD is not set
 # CONFIG_EXAMPLES_POSIXSPAWN is not set
 # CONFIG_EXAMPLES_QENCODER is not set
 # CONFIG_EXAMPLES_RGMP is not set
 # CONFIG_EXAMPLES_ROMFS is not set
 # CONFIG_EXAMPLES_SENDMAIL is not set
+# CONFIG_EXAMPLES_SERIALBLASTER is not set
+# CONFIG_EXAMPLES_SERIALRX is not set
 # CONFIG_EXAMPLES_SERLOOP is not set
 # CONFIG_EXAMPLES_SLCD is not set
 # CONFIG_EXAMPLES_SMART is not set
@@ -448,7 +608,6 @@ CONFIG_EXAMPLES_NSH=y
 # CONFIG_EXAMPLES_THTTPD is not set
 # CONFIG_EXAMPLES_TIFF is not set
 # CONFIG_EXAMPLES_TOUCHSCREEN is not set
-# CONFIG_EXAMPLES_UDP is not set
 # CONFIG_EXAMPLES_WEBSERVER is not set
 # CONFIG_EXAMPLES_USBSERIAL is not set
 # CONFIG_EXAMPLES_USBTERM is not set
@@ -458,12 +617,15 @@ CONFIG_EXAMPLES_NSH=y
 # Graphics Support
 #
 # CONFIG_TIFF is not set
+# CONFIG_GRAPHICS_TRAVELER is not set
 
 #
 # Interpreters
 #
+# CONFIG_INTERPRETERS_BAS is not set
 # CONFIG_INTERPRETERS_FICL is not set
 # CONFIG_INTERPRETERS_PCODE is not set
+# CONFIG_INTERPRETERS_MICROPYTHON is not set
 
 #
 # Network Utilities
@@ -473,15 +635,11 @@ CONFIG_EXAMPLES_NSH=y
 # Networking Utilities
 #
 # CONFIG_NETUTILS_CODECS is not set
-# CONFIG_NETUTILS_DHCPD is not set
 # CONFIG_NETUTILS_FTPC is not set
-# CONFIG_NETUTILS_FTPD is not set
 # CONFIG_NETUTILS_JSON is not set
 # CONFIG_NETUTILS_SMTP is not set
-# CONFIG_NETUTILS_TFTPC is not set
 # CONFIG_NETUTILS_THTTPD is not set
-# CONFIG_NETUTILS_NETLIB is not set
-# CONFIG_NETUTILS_WEBCLIENT is not set
+# CONFIG_NETUTILS_PPPD is not set
 
 #
 # FreeModBus
@@ -491,73 +649,7 @@ CONFIG_EXAMPLES_NSH=y
 #
 # NSH Library
 #
-CONFIG_NSH_LIBRARY=y
-CONFIG_NSH_READLINE=y
-# CONFIG_NSH_CLE is not set
-
-#
-# Disable Individual commands
-#
-CONFIG_NSH_DISABLE_ADDROUTE=y
-# CONFIG_NSH_DISABLE_CAT is not set
-# CONFIG_NSH_DISABLE_CD is not set
-# CONFIG_NSH_DISABLE_CP is not set
-CONFIG_NSH_DISABLE_CMP=y
-CONFIG_NSH_DISABLE_DD=y
-CONFIG_NSH_DISABLE_DF=y
-CONFIG_NSH_DISABLE_DELROUTE=y
-# CONFIG_NSH_DISABLE_ECHO is not set
-CONFIG_NSH_DISABLE_EXEC=y
-CONFIG_NSH_DISABLE_EXIT=y
-# CONFIG_NSH_DISABLE_FREE is not set
-CONFIG_NSH_DISABLE_GET=y
-# CONFIG_NSH_DISABLE_HELP is not set
-CONFIG_NSH_DISABLE_HEXDUMP=y
-# CONFIG_NSH_DISABLE_IFCONFIG is not set
-# CONFIG_NSH_DISABLE_KILL is not set
-CONFIG_NSH_DISABLE_LOSETUP=y
-# CONFIG_NSH_DISABLE_LS is not set
-# CONFIG_NSH_DISABLE_MB is not set
-# CONFIG_NSH_DISABLE_MKDIR is not set
-CONFIG_NSH_DISABLE_MKFIFO=y
-CONFIG_NSH_DISABLE_MKRD=y
-# CONFIG_NSH_DISABLE_MH is not set
-# CONFIG_NSH_DISABLE_MOUNT is not set
-# CONFIG_NSH_DISABLE_MW is not set
-# CONFIG_NSH_DISABLE_PS is not set
-CONFIG_NSH_DISABLE_PUT=y
-# CONFIG_NSH_DISABLE_PWD is not set
-# CONFIG_NSH_DISABLE_RM is not set
-# CONFIG_NSH_DISABLE_RMDIR is not set
-# CONFIG_NSH_DISABLE_SET is not set
-# CONFIG_NSH_DISABLE_SH is not set
-# CONFIG_NSH_DISABLE_SLEEP is not set
-# CONFIG_NSH_DISABLE_TEST is not set
-# CONFIG_NSH_DISABLE_UMOUNT is not set
-# CONFIG_NSH_DISABLE_UNSET is not set
-# CONFIG_NSH_DISABLE_USLEEP is not set
-CONFIG_NSH_DISABLE_WGET=y
-CONFIG_NSH_DISABLE_XD=y
-
-#
-# Configure Command Options
-#
-CONFIG_NSH_CODECS_BUFSIZE=128
-CONFIG_NSH_FILEIOSIZE=512
-CONFIG_NSH_LINELEN=64
-CONFIG_NSH_DISABLE_SEMICOLON=y
-CONFIG_NSH_MAXARGUMENTS=6
-# CONFIG_NSH_ARGCAT is not set
-CONFIG_NSH_NESTDEPTH=3
-CONFIG_NSH_DISABLESCRIPT=y
-# CONFIG_NSH_DISABLEBG is not set
-CONFIG_NSH_CONSOLE=y
-
-#
-# USB Trace Support
-#
-# CONFIG_NSH_ALTCONDEV is not set
-# CONFIG_NSH_ARCHINIT is not set
+# CONFIG_NSH_LIBRARY is not set
 
 #
 # NxWidgets/NxWM
@@ -571,97 +663,27 @@ CONFIG_NSH_CONSOLE=y
 #
 # System Libraries and NSH Add-Ons
 #
-
-#
-# USB CDC/ACM Device Commands
-#
-
-#
-# USB Composite Device Commands
-#
-
-#
-# Custom Free Memory Command
-#
 # CONFIG_SYSTEM_FREE is not set
-
-#
-# I2C tool
-#
-
-#
-# INI File Parser
-#
-# CONFIG_SYSTEM_INIFILE is not set
-
-#
-# FLASH Program Installation
-#
+# CONFIG_SYSTEM_CLE is not set
+# CONFIG_SYSTEM_CUTERM is not set
 # CONFIG_SYSTEM_INSTALL is not set
-
-#
-# FLASH Erase-all Command
-#
-
-#
-# NxPlayer media player library / command Line
-#
-# CONFIG_SYSTEM_NXPLAYER is not set
-
-#
-# RAM test
-#
+# CONFIG_SYSTEM_HEX2BIN is not set
+# CONFIG_SYSTEM_INIFILE is not set
 # CONFIG_SYSTEM_RAMTEST is not set
-
-#
-# readline()
-#
-CONFIG_SYSTEM_READLINE=y
-CONFIG_READLINE_ECHO=y
-
-#
-# Power Off
-#
+# CONFIG_SYSTEM_READLINE is not set
 # CONFIG_SYSTEM_POWEROFF is not set
-
-#
-# RAMTRON
-#
 # CONFIG_SYSTEM_RAMTRON is not set
-
-#
-# SD Card
-#
 # CONFIG_SYSTEM_SDCARD is not set
-
-#
-# Sysinfo
-#
+# CONFIG_SYSTEM_SUDOKU is not set
 # CONFIG_SYSTEM_SYSINFO is not set
-
-#
-# USB Monitor
-#
-
-#
-# EMACS-like Command Line Editor
-#
-# CONFIG_SYSTEM_CLE is not set
-
-#
-# VI Work-Alike Editor
-#
 # CONFIG_SYSTEM_VI is not set
-
-#
-# Stack Monitor
-#
-
-#
-# USB Mass Storage Device Commands
-#
-
-#
-# Zmodem Commands
-#
+CONFIG_SYSTEM_USBMSC=y
+CONFIG_SYSTEM_USBMSC_NLUNS=1
+CONFIG_SYSTEM_USBMSC_DEVMINOR1=0
+CONFIG_SYSTEM_USBMSC_DEVPATH1="/dev/mtdblock0"
+CONFIG_SYSTEM_USBMSC_DEVMINOR2=1
+CONFIG_SYSTEM_USBMSC_DEVPATH2="/dev/mmcsd1"
+CONFIG_SYSTEM_USBMSC_DEVMINOR3=2
+CONFIG_SYSTEM_USBMSC_DEVPATH3="/dev/mmcsd2"
+# CONFIG_SYSTEM_USBMSC_DEBUGMM is not set
 # CONFIG_SYSTEM_ZMODEM is not set
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/teensy/nsh/ld.script src/nuttx/configs/teensy/nsh/ld.script
--- tmp/nuttx/configs/teensy/nsh/ld.script	2015-05-25 19:55:23.126821951 +0300
+++ src/nuttx/configs/teensy/nsh/ld.script	2015-05-31 15:38:57.975847046 +0300
@@ -130,6 +130,7 @@ SECTIONS
 		*(.handlers)
 		*(.text)
 		*(.text.*)
+		*(.progmem.*)
 		_etext = . ;
 	} > flash
 
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/teensy/nsh/Make.defs src/nuttx/configs/teensy/nsh/Make.defs
--- tmp/nuttx/configs/teensy/nsh/Make.defs	2015-05-25 19:55:23.126821951 +0300
+++ src/nuttx/configs/teensy/nsh/Make.defs	2015-05-31 13:26:03.776191031 +0300
@@ -63,7 +63,7 @@ OBJCOPY = $(CROSSDEV)objcopy
 OBJDUMP = $(CROSSDEV)objdump
 
 ifeq ($(CONFIG_DEBUG_SYMBOLS),y)
-  ARCHOPTIMIZATION = -g
+  ARCHOPTIMIZATION = -g -gdwarf-2
 endif
 
 ifneq ($(CONFIG_DEBUG_NOOPT),y)
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/teensy/src/at90usb_boot.c src/nuttx/configs/teensy/src/at90usb_boot.c
--- tmp/nuttx/configs/teensy/src/at90usb_boot.c	2015-05-25 19:55:23.126821951 +0300
+++ src/nuttx/configs/teensy/src/at90usb_boot.c	2015-05-31 13:35:08.420167536 +0300
@@ -42,6 +42,9 @@
 #include <debug.h>
 
 #include <arch/board/board.h>
+#include <nuttx/mtd/mtd.h>
+#include <nuttx/spi/spi.h>
+#include <nuttx/board.h>
 
 #include "up_arch.h"
 #include "up_internal.h"
@@ -90,3 +93,49 @@ void at90usb_boardinitialize(void)
   at90usb_ledinit();
 #endif
 }
+
+/****************************************************************************
+ * Public Functions
+ ****************************************************************************/
+
+/****************************************************************************
+ * Name: board_app_initialize
+ *
+ * Description:
+ *   Perform architecture specific initialization for NSH.
+ *
+ *   CONFIG_NSH_ARCHINIT=y :
+ *     Called from the NSH library
+ *
+ *   CONFIG_BOARD_INITIALIZE=y, CONFIG_NSH_LIBRARY=y, &&
+ *   CONFIG_NSH_ARCHINIT=n:
+ *     Called from board_initialize().
+ *
+ ****************************************************************************/
+
+int board_app_initialize(void)
+{
+  struct spi_dev_s *spi;
+  FAR struct mtd_dev_s *mtd;
+  int ret;
+
+  spi = up_spiinitialize(0);
+  if (spi == NULL)
+  {
+    return -1;
+  }
+
+  mtd = m25p_initialize(spi);
+  if (!mtd)
+  {
+    return -1;
+  }
+
+  ret = ftl_initialize(0, mtd);
+  if (ret < 0)
+  {
+    return -1;
+  }
+
+  return 0;
+}
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/teensy/src/at90usb_spi.c src/nuttx/configs/teensy/src/at90usb_spi.c
--- tmp/nuttx/configs/teensy/src/at90usb_spi.c	2015-05-25 19:55:23.126821951 +0300
+++ src/nuttx/configs/teensy/src/at90usb_spi.c	2015-05-31 13:26:03.776191031 +0300
@@ -178,6 +178,7 @@ void  avr_spiselect(FAR struct spi_dev_s
 uint8_t avr_spistatus(FAR struct spi_dev_s *dev, enum spi_dev_e devid)
 {
   uint8_t ret = 0;
+#if 0
   uint8_t regval = PINB;
 
   /* Both the CD and WP pins are pull high by the AT90USB and will be
@@ -193,7 +194,7 @@ uint8_t avr_spistatus(FAR struct spi_dev
     {
       ret |= SPI_STATUS_WRPROTECTED;
     }
-
+#endif
   sspdbg("Returning %02x\n", ret);
   return ret;
 }
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/teensy/src/at90usb_usbmsc.c src/nuttx/configs/teensy/src/at90usb_usbmsc.c
--- tmp/nuttx/configs/teensy/src/at90usb_usbmsc.c	2015-05-25 19:55:23.126821951 +0300
+++ src/nuttx/configs/teensy/src/at90usb_usbmsc.c	2015-05-31 13:34:57.616168002 +0300
@@ -46,6 +46,7 @@
 #include <errno.h>
 
 #include <nuttx/spi/spi.h>
+#include <nuttx/board.h>
 #include <nuttx/mmcsd.h>
 
 #include "at90usb_internal.h"
@@ -87,6 +88,7 @@
 
 int usbmsc_archinitialize(void)
 {
+#if 0
   FAR struct spi_dev_s *spi;
   int ret;
 
@@ -113,4 +115,7 @@ int usbmsc_archinitialize(void)
     }
 
   return OK;
+#else
+  return board_app_initialize();
+#endif
 }
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/drivers/mtd/ftl.c src/nuttx/drivers/mtd/ftl.c
--- tmp/nuttx/drivers/mtd/ftl.c	2015-05-25 19:55:23.178821949 +0300
+++ src/nuttx/drivers/mtd/ftl.c	2015-05-31 13:26:03.780191030 +0300
@@ -78,6 +78,8 @@ struct ftl_struct_s
 #ifdef CONFIG_FS_WRITABLE
   FAR uint8_t          *eblock;  /* One, in-memory erase block */
 #endif
+  uint8_t               sectorscale;
+  uint8_t               erasescale;
 };
 
 /****************************************************************************
@@ -189,10 +191,14 @@ static ssize_t ftl_read(FAR struct inode
   DEBUGASSERT(inode && inode->i_private);
 
   dev = (FAR struct ftl_struct_s *)inode->i_private;
+
+  start_sector *= dev->sectorscale;
+  nsectors *= dev->sectorscale;
+
 #ifdef CONFIG_FTL_READAHEAD
-  return rwb_read(&dev->rwb, start_sector, nsectors, buffer);
+  return rwb_read(&dev->rwb, start_sector, nsectors, buffer) / dev->sectorscale;
 #else
-  return ftl_reload(dev, buffer, start_sector, nsectors);
+  return ftl_reload(dev, buffer, start_sector, nsectors) / dev->sectorscale;
 #endif
 }
 
@@ -248,7 +254,7 @@ static ssize_t ftl_flush(FAR void *priv,
       /* Then erase the erase block */
 
       eraseblock = rwblock / dev->blkper;
-      ret        = MTD_ERASE(dev->mtd, eraseblock, 1);
+      ret        = MTD_ERASE(dev->mtd, eraseblock, 1 * dev->erasescale); // XXX
       if (ret < 0)
         {
           fdbg("Erase block=%d failed: %d\n", eraseblock, ret);
@@ -303,7 +309,7 @@ static ssize_t ftl_flush(FAR void *priv,
       /* Erase the erase block */
 
       eraseblock = alignedblock / dev->blkper;
-      ret        = MTD_ERASE(dev->mtd, eraseblock, 1);
+      ret        = MTD_ERASE(dev->mtd, eraseblock, 1 * dev->erasescale); // XXX
       if (ret < 0)
         {
           fdbg("Erase block=%d failed: %d\n", eraseblock, ret);
@@ -345,7 +351,7 @@ static ssize_t ftl_flush(FAR void *priv,
       /* Then erase the erase block */
 
       eraseblock = alignedblock / dev->blkper;
-      ret        = MTD_ERASE(dev->mtd, eraseblock, 1);
+      ret        = MTD_ERASE(dev->mtd, eraseblock, 1 * dev->erasescale); // XXX
       if (ret < 0)
         {
           fdbg("Erase block=%d failed: %d\n", eraseblock, ret);
@@ -389,11 +395,16 @@ static ssize_t ftl_write(FAR struct inod
   fvdbg("sector: %d nsectors: %d\n", start_sector, nsectors);
 
   DEBUGASSERT(inode && inode->i_private);
+
   dev = (struct ftl_struct_s *)inode->i_private;
+
+  start_sector *= dev->sectorscale;
+  nsectors *= dev->sectorscale;
+
 #ifdef CONFIG_FTL_WRITEBUFFER
-  return rwb_write(&dev->rwb, start_sector, nsectors, buffer);
+  return rwb_write(&dev->rwb, start_sector, nsectors, buffer) / dev->sectorscale;
 #else
-  return ftl_flush(dev, buffer, start_sector, nsectors);
+  return ftl_flush(dev, buffer, start_sector, nsectors) / dev->sectorscale;
 #endif
 }
 #endif
@@ -422,8 +433,8 @@ static int ftl_geometry(FAR struct inode
 #else
       geometry->geo_writeenabled  = false;
 #endif
-      geometry->geo_nsectors      = dev->geo.neraseblocks * dev->blkper;
-      geometry->geo_sectorsize    = dev->geo.blocksize;
+      geometry->geo_nsectors      = dev->geo.neraseblocks * dev->blkper / dev->sectorscale;
+      geometry->geo_sectorsize    = dev->geo.blocksize * dev->sectorscale;
 
       fvdbg("available: true mediachanged: false writeenabled: %s\n",
             geometry->geo_writeenabled ? "true" : "false");
@@ -525,7 +536,7 @@ int ftl_initialize(int minor, FAR struct
 
   /* Allocate a FTL device structure */
 
-  dev = (struct ftl_struct_s *)kmm_malloc(sizeof(struct ftl_struct_s));
+  dev = (struct ftl_struct_s *)kmm_zalloc(sizeof(struct ftl_struct_s));
   if (dev)
     {
       /* Initialize the FTL device structure */
@@ -545,16 +556,33 @@ int ftl_initialize(int minor, FAR struct
           return ret;
         }
 
-      /* Allocate one, in-memory erase block buffer */
+      /* FIXME add comment */
 
-#ifdef CONFIG_FS_WRITABLE
-      dev->eblock  = (FAR uint8_t *)kmm_malloc(dev->geo.erasesize);
-      if (!dev->eblock)
+      dev->sectorscale = 1;
+      if (dev->geo.blocksize < 512)
         {
-          fdbg("Failed to allocate an erase block buffer\n");
-          kmm_free(dev);
-          return -ENOMEM;
+    	  dev->sectorscale = 512 / dev->geo.blocksize;
         }
+
+      dev->erasescale = 1;
+      if (dev->geo.erasesize < 512)
+        {
+          dev->erasescale = 512 / dev->geo.erasesize;
+        }
+
+      /* Allocate one, in-memory erase block buffer */
+
+#ifdef CONFIG_FS_WRITABLE
+      if (dev->geo.blocksize != dev->geo.erasesize)
+      {
+        dev->eblock  = (FAR uint8_t *)kmm_malloc(dev->geo.erasesize);
+        if (!dev->eblock)
+          {
+            fdbg("Failed to allocate an erase block buffer\n");
+            kmm_free(dev);
+            return -ENOMEM;
+          }
+      }
 #endif
 
       /* Get the number of R/W blocks per erase block */
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/drivers/mtd/m25px.c src/nuttx/drivers/mtd/m25px.c
--- tmp/nuttx/drivers/mtd/m25px.c	2015-05-25 19:55:23.178821949 +0300
+++ src/nuttx/drivers/mtd/m25px.c	2015-05-31 13:26:03.780191030 +0300
@@ -89,6 +89,7 @@
 #define M25P_MEMORY_TYPE           CONFIG_M25P_MEMORY_TYPE
 #define M25P_RES_ID                0x13
 #define M25P_M25P1_CAPACITY        0x11 /* 1 M-bit */
+#define M25P_M25P20_CAPACITY       0x12 /* 2 M-bit */
 #define M25P_EN25F80_CAPACITY      0x14 /* 8 M-bit */
 #define M25P_M25P16_CAPACITY       0x15 /* 16 M-bit */
 #define M25P_M25P32_CAPACITY       0x16 /* 32 M-bit */
@@ -100,11 +101,23 @@
  *  (512 pages) * (256 bytes per page)
  */
 
-#define M25P_M25P1_SECTOR_SHIFT    15    /* Sector size 1 << 15 = 65,536 */
+#define M25P_M25P1_SECTOR_SHIFT    15    /* Sector size 1 << 15 = 32,768 */
 #define M25P_M25P1_NSECTORS        4
 #define M25P_M25P1_PAGE_SHIFT      8     /* Page size 1 << 8 = 256 */
 #define M25P_M25P1_NPAGES          512
 
+/*  M25P20 capacity is 262,144 bytes:
+ *  (8 sectors) * (65,536 bytes per sector)
+ *  (1024 pages) * (256 bytes per page)
+ */
+
+#define M25P_M25P20_SECTOR_SHIFT    16    /* Sector size 1 << 16 = 65,536 */
+#define M25P_M25P20_NSECTORS        4
+#define M25P_M25P20_PAGE_SHIFT      8     /* Page size 1 << 8 = 256 */
+#define M25P_M25P20_NPAGES          1024
+#define M25P_M25P20_SUBSECT_SHIFT	8     /* Sub-Sector size 1 << 8 = 256 (for M25PE20) */
+#define M25P_M25P20_NSUBSECTORS     1024
+
 /*  EN25F80 capacity is 1,048,576 bytes:
  *  (16 sectors) * (65,536 bytes per sector)
  *  (512 pages) * (256 bytes per page)
@@ -114,7 +127,7 @@
 #define M25P_EN25F80_NSECTORS      16
 #define M25P_EN25F80_PAGE_SHIFT    8     /* Page size 1 << 8 = 256 */
 #define M25P_EN25F80_NPAGES        4096
-#define M25P_EN25F80_SUBSECT_SHIFT 12   /* Sub-Sector size 1 << 12 = 4,096 */
+#define M25P_EN25F80_SUBSECT_SHIFT 12    /* Sub-Sector size 1 << 12 = 4,096 */
 #define M25P_EN25F80_NSUBSECTORS   256
 
 /*  M25P16 capacity is 2,097,152 bytes:
@@ -172,7 +185,7 @@
 #define M25P_BE        0xc7    /* 1 Bulk Erase                0   0     0     */
 #define M25P_DP        0xb9    /* 2 Deep power down           0   0     0     */
 #define M25P_RES       0xab    /* 2 Read Electronic Signature 0   3     >=1   */
-#define M25P_SSE       0x20    /* 3 Sub-Sector Erase          0   0     0     */
+#define M25P_SSE       0xdb//0x20    /* 3 Sub-Sector Erase          0   0     0     */
 
 /* NOTE 1: All parts.
  * NOTE 2: M25P632/M25P64
@@ -348,6 +361,19 @@ static inline int m25p_readid(struct m25
            priv->npages         = M25P_M25P1_NPAGES;
            return OK;
         }
+	  if (capacity == M25P_M25P20_CAPACITY)
+		{
+           /* Save the FLASH geometry */
+
+           priv->sectorshift    = M25P_M25P20_SECTOR_SHIFT;
+           priv->nsectors       = M25P_M25P20_NSECTORS;
+           priv->pageshift      = M25P_M25P20_PAGE_SHIFT;
+           priv->npages         = M25P_M25P20_NPAGES;
+#ifdef CONFIG_M25P_SUBSECTOR_ERASE
+           priv->subsectorshift = M25P_M25P20_SUBSECT_SHIFT;
+#endif
+           return OK;
+        }
       else if (capacity == M25P_EN25F80_CAPACITY)
         {
            /* Save the FLASH geometry */
@@ -473,7 +499,7 @@ static void m25p_waitwritecomplete(struc
       if ((status & M25P_SR_WIP) != 0)
         {
           m25p_unlock(priv->dev);
-          usleep(1000);
+          up_mdelay(1);//usleep(1000); // FIXME
           m25p_lock(priv->dev);
         }
     }
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/include/nuttx/compiler.h src/nuttx/include/nuttx/compiler.h
--- tmp/nuttx/include/nuttx/compiler.h	2015-05-25 19:55:23.258821948 +0300
+++ src/nuttx/include/nuttx/compiler.h	2015-05-31 13:26:03.780191030 +0300
@@ -474,7 +474,7 @@
 # undef  CONFIG_CAN_PASS_STRUCTS
 
 #endif
-
+# undef  CONFIG_HAVE_LONG_LONG
 /****************************************************************************
  * Global Function Prototypes
  ****************************************************************************/
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/tools/Config.mk src/nuttx/tools/Config.mk
--- tmp/nuttx/tools/Config.mk	2015-05-25 19:55:23.410821944 +0300
+++ src/nuttx/tools/Config.mk	2015-05-31 13:26:03.780191030 +0300
@@ -114,7 +114,7 @@ endef
 
 define COMPILE
 	@echo "CC: $1"
-	$(Q) $(CC) -c $(CFLAGS) $1 -o $2
+	$(Q) $(CC) -c $(CFLAGS) $(addprefix $(shell pwd)/,$1) -o $(addprefix $(shell pwd)/,$2)
 endef
 
 # COMPILEXX - Default macro to compile one C++ file
@@ -149,7 +149,7 @@ endef
 
 define ASSEMBLE
 	@echo "AS: $1"
-	$(Q) $(CC) -c $(AFLAGS) $1 -o $2
+	$(Q) $(CC) -c $(AFLAGS) $(addprefix $(shell pwd)/,$1) -o $(addprefix $(shell pwd)/,$2)
 endef
 
 # MOVEOBJ - Default macro to move an object file to the correct location
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/.version src/nuttx/.version
--- tmp/nuttx/.version	1970-01-01 03:00:00.000000000 +0300
+++ src/nuttx/.version	2015-05-31 13:26:03.780191030 +0300
@@ -0,0 +1,6 @@
+#!/bin/bash
+
+CONFIG_VERSION_STRING="0.0"
+CONFIG_VERSION_MAJOR=0
+CONFIG_VERSION_MINOR=0
+CONFIG_VERSION_BUILD="0"
